<!doctype html>
<html>

<head>
  <title>Agrow Help</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="../seedling.svg" type="image/gif" sizes="16x16">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
    integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <style>
    .navbar-light .navbar-brand {
      color: white;
    }

    .shadow-sm {
      box-shadow: 0 .125rem .25rem rgba(0, 0, 0, .075) !important;
    }

    ::placeholder {
      color: #28ec28;
      opacity: 1;
      /* Firefox */
    }

    :-ms-input-placeholder {
      /* Internet Explorer 10-11 */
      color: #28ec28;
    }

    ::-ms-input-placeholder {
      /* Microsoft Edge */
      color: #28ec28;
    }

    #cropType {
      margin-right: 20px;
    }

    .buttons-margin {
      margin: 0px 5%;
    }

    a {
      cursor: pointer;
      color: #9e8516f5;
    }

    table th {
      color: #9e8516f5;
    }

    a:hover {
      color: rgb(80, 80, 241);
    }

    #imageStyling {
      height: 225px;
      width: 100%;
      display: block;
      padding: 5px;
    }

    #showIf {
      display: none;
    }

    .parent {
      -moz-column-count: 2;
      -moz-column-gap: 40%;
      -webkit-column-count: 2;
      -webkit-column-gap: 40%;
      column-count: 2;
      column-gap: 40%;
    }

    a.text-dark:focus,
    a.text-dark:hover {
      color: #26cf26;
    }
  </style>

</head>

<body class="bg-light" data-new-gr-c-s-check-loaded="14.984.0" data-gr-ext-installed="">
  <div class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 bg-white border-bottom shadow-sm">
    <h5 class="my-0 mr-md-auto font-weight-normal logo">
      <img src="logo.svg" alt="image">
    </h5>
    <nav class="my-2 my-md-0 mr-md-3">
      <a class="p-2 text-dark" href="dashbord.html"><b style="color: #26cf26;">Crops</b></a>
      <a class="p-2 text-dark" href="forum.html"><b style="color: #26cf26;"> Forum </b></a>
      <a class="p-2 text-dark" href="machinery.html"> <b style="color: #26cf26;">Machinery Help</b></a>
      <a href="profile.html"> <i class="fa fa-user" aria-hidden="true"></i></a>
    </nav>

  </div>




  <main role="main" class="">
    <br>
    <div class="row">
      <div class="col-md-7">
        <h1 style="margin-left: 30px; color: #26cf26;font-family: Gill Sans Extrabold, sans-serif;"> Profile Management
        </h1>
      </div>
      <div class="col-md-5" style="left: 25%;">

        <div class="col-md-4">
          <a onclick="logout()"><button class="btn  btn-success btn-block"> Logout </button></a>
        </div>

      </div>
    </div>

    <div class="container-fluid">
      <div class="my-2 p-3 bg-white rounded shadow-sm">
        <h3 style=" color: #9e8516f5;" class="border-bottom border-gray pb-2 mb-0" id="profileName"></h3>
        <br>
        <h4 style=" color: #26cf26;" id="showIf" class="border-bottom border-gray pb-2 mb-0"> Crops Details Provided
        </h4>
        <div class="buttons-margin">
          <br>
          <div class="row" id="cropList">

          </div>
        </div>
        <br>
        <hr>
        <h4 style="color: #26cf26" class="border-bottom border-gray pb-2 mb-0">Tools Posted</h4>
        <br>
        <div id="tableVIew">

        </div>

      </div>

      <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
        aria-hidden="true" >
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">Submit Tool</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="p-2">
                <H2 style="color: #26cf26;">Description</H2>
                <textarea rows="2" cols="50" placeholder="Give inputs about the crop " aria-describedby="button-addon1"
                  class="form-control border-0 bg-light" style="color: #28A745;" id="newdescription"></textarea>
                <H2 style="color: #26cf26;"> Fertilizer</H2>
                <input type="search" placeholder="Enter the Fertilizer that you have used" aria-describedby="button-addon1"
                  class="form-control border-0 bg-light" style="color: #28ec28;" id="newFertilizer">
      
                <br>
                <div class="parent">
                  <div>
                    <H2 style="color: #26cf26;"> Weather Condition </H2>
                    <!-- <p style="color: #9e8516f5;">55°F and 75°F</p></div> -->
                    <input type="search" placeholder="Tell us suitable weather condition" aria-describedby="button-addon1"
                      class="form-control border-0 bg-light" style="color: #28ec28;" id="newweather">
                    <div>
                      <H2 style="color: #26cf26;"> Water Timings </H2>
                      <input type="search" placeholder="Enter the Water Timings" aria-describedby="button-addon1"
                        class="form-control border-0 bg-light" style="color: #28ec28;" id="newWater">
                    </div>
                  </div>
      
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="button" class="btn  btn-success " onclick="submitHandel()">Submit</button>
            </div>
          </div>
        </div>
      </div>

     <!-- // <a id="cropcropType" class=" btn btn-outline-success col-md-1" data-toggle="modal" data-target=".bd-example-modal-lg" style="display: none;">link</a> -->

  </main>

  <script>
    let getpId
    let getQId
    let userDetails;
    let myParam, cropsDetails,postedTools,selectedCropId,selectedCropName
    (function (document) {

      const localdetails = JSON.parse(localStorage.getItem('userDetails'));

      let req = new XMLHttpRequest();
      let requestUrl = `${'http://localhost:5000/api/users/'}${localdetails.id}`
      req.open('GET', requestUrl, true);
      req.setRequestHeader('Content-type', 'application/json');

      req.send();
      req.onload = () => {
        let data = JSON.parse(req.responseText)
        if (req.readyState == 4 && req.status == "201") {
          userDetails = data.user;
          document.getElementById('profileName').innerHTML = 'User Name :- ' + userDetails.userName.charAt(0).toUpperCase() + userDetails.userName.slice(1);
           postedTools = userDetails.postedTools;
          cropsDetails = userDetails.cropsDetails
          // setTimeout(() => {
          //   console.log(postedTools);
          // }, 1000);

          if (userDetails.role == '2') {
            let newNode="";
            document.getElementById('showIf').style.display = 'block'
            cropsDetails.map(crop => {
              console.log(JSON.stringify(crop))
              let object = JSON.stringify(crop)
              //  let newNode = document.createElement('a');
              // newNode.id = "cropType";
              // newNode.className = "btn btn-outline-success col-md-1";
              
              // newNode.style.display='block'
              // newNode.innerHTML = crop.cName.charAt(0).toUpperCase() + crop.cName.slice(1);
              newNode += "<a id=\"cropcropType\" class=\" btn btn-outline-success col-md-1\" data-toggle=\"modal\" data-target=\".bd-example-modal-lg\" onclick=\"popModel(\'" + crop.id + "\'" + ")\" >" + crop.cName.charAt(0).toUpperCase() + crop.cName.slice(1) + "</a>";
              //newNode +=  "</a>";
              
              // newNode.onclick = function () {
              //   popModel(crop);
              // };
              
              
            })
            document.getElementById('cropList').innerHTML= newNode;

          }



          const tbl = document.createElement("table");
          tbl.className = 'table';
          const tblhead = document.createElement("thead");
          let hRow = document.createElement('tr');
          const toolNameElement = document.createElement('th');
          const quanElement = document.createElement('th');
          const priceElement = document.createElement('th');
          const actionElement = document.createElement('th');

          toolNameElement.innerHTML = "Tool Name";
          quanElement.innerHTML = "Quanity";
          priceElement.innerHTML = "Price";
          actionElement.innerHTML = "Action"



          hRow.appendChild(toolNameElement);
          hRow.appendChild(quanElement);
          hRow.appendChild(priceElement);
          hRow.appendChild(actionElement);
          tblhead.appendChild(hRow)
          const tblBody = document.createElement("tbody");
          let row;

          postedTools.map(t => {
            row = document.createElement('tr');


            const thElement = document.createElement('th');
            const tdquan = document.createElement('td');
            const price = document.createElement('td');
            const tdAccept = document.createElement('td');
            thElement.innerHTML = t.toolName;
            let divIG = document.createElement('div');
            divIG.className = 'input-group';
            let input1 = document.createElement('input');
            input1.type = 'text';
            input1.className = "form-control border-0 bg-light";
            input1.style = "color: #28A745;";
            input1.disabled = true
            input1.id = "qua" + t.id;
            input1.value = t.quantity
            divIG.appendChild(input1);
            tdquan.appendChild(divIG)

            let divIG1 = document.createElement('div');
            divIG1.className = 'input-group';
            let input2 = document.createElement('input');
            input2.type = 'text';
            input2.className = "form-control border-0 bg-light";
            input2.style = "color: #28A745;";
            input2.disabled = true
            input2.id = "pri" + t.id;
            input2.value = t.price
            divIG1.appendChild(input2);

            price.appendChild(divIG1);
            // const tdReject = document.createElement('td');
            const buttonAc = document.createElement('button');
            buttonAc.type = 'button';
            buttonAc.className = 'btn btn-outline-warning btn-sm';
            getpId = document.getElementById('p' + t.id);
            getQId = document.getAnimations('q' + t.id);

            buttonAc.id = 'b' + t.id;
            buttonAc.style.display = "block";
            buttonAc.onclick = function () {
              edit(t, getQId, getpId,);
            };

            buttonAc.innerHTML = 'Edit';

            const buttonSub = document.createElement('button');
            buttonSub.type = 'button';
            buttonSub.className = 'btn btn-outline-success btn-sm';
            buttonSub.style.display = "none";
            buttonSub.id = 's' + t.id;

            buttonSub.onclick = function () {
              submit(t);
            };

            buttonSub.innerHTML = 'Submit';
            tdAccept.appendChild(buttonAc);
            tdAccept.appendChild(buttonSub);

            row.appendChild(thElement);
            row.appendChild(tdquan);
            row.appendChild(price);
            row.appendChild(tdAccept);
            tblBody.appendChild(row)
          })

          tbl.appendChild(tblhead)
          tbl.appendChild(tblBody);
          document.getElementById("tableVIew").appendChild(tbl);


          /// offered


        } else {
          console.log(data)
        }
      }







    })(document);


    $('cropType').on( "click", function() {
   $('#myModal').modal('show');
});

    function logout() {
      localStorage.clear()
      location.replace("http://localhost:5000");
    }


    function popModel(params) {
      console.log((params))
      cropsDetails.find( cr =>{
       if(cr.id == params){
        document.getElementById('newdescription').value = cr.description;
      document.getElementById('newFertilizer').value = cr.ferilizer;
     document.getElementById('newweather').value = cr.weather;
     document.getElementById('newWater').value = cr.waterTiming;
     selectedCropId =  cr.cid;
     selectedCropName = cr.cName;
       }
      })
      }


    function edit(params, Qid, Pid) {
      let buttonChange = document.getElementById('b' + params.id);
      buttonChange.style.display = 'none';
      document.getElementById('s' + params.id).style.display = 'block';
      document.getElementById('qua' + params.id).disabled = false;
      document.getElementById('pri' + params.id).disabled = false;
     

    }



    function submit(params) {
      let buttonChange = document.getElementById('b' + params.id);
      buttonChange.style.display = 'block';
      document.getElementById('s' + params.id).style.display = 'none';
      document.getElementById('qua' + params.id).disabled = true;
      document.getElementById('pri' + params.id).disabled = true;
      
      postedTools.find(p => {
        if(p.id === params.id){
          p.quantity = document.getElementById('qua' + params.id).value;
          p.price =document.getElementById('pri' + params.id).value;
        }
      })

      let data={
        
        'fid':userDetails.id,
        'price':document.getElementById('pri' + params.id).value,
        'toolName': params.toolName,
        'quantity': Number(document.getElementById('qua' + params.id).value),
        'toolId':params.toolid,
        'postedTools':postedTools
      }
      console.log(data)
      let req = new XMLHttpRequest();
      let requestUrl = `${'http://localhost:5000/api/tools/update'}`
      req.open('PATCH', requestUrl, true);
      req.setRequestHeader('Content-type', 'application/json');
      let json = JSON.stringify({ data });
      req.send(json);
      req.onload = () => {
        let data = JSON.parse(req.responseText)
        if (req.readyState == 4 && req.status == "201") {
          window.location.reload()
          alert(data.message)
        } else {
          console.log(data.message)
        }
      }


    }




    function submitHandel() {
      const fid = userDetails.id;

      const description = document.getElementById('newdescription').value;
      const ferilizer = document.getElementById('newFertilizer').value;
      const weather = document.getElementById('newweather').value;
      const waterTiming = document.getElementById('newWater').value;


      let data = {
        'description': description,
        'ferilizer': ferilizer,
        'weather': weather,
        'waterTiming': waterTiming,
        'cName':selectedCropName,
        'cid':selectedCropId
      }
     // console.log(data)
      userDetails.cropsDetails.find(c =>{
        if(c.cid== selectedCropId){
          c= data;
        }
      })
      console.log(userDetails.cropsDetails)
      // let req = new XMLHttpRequest();
      // let requestUrl = `${'http://localhost:5000/api/tools/create'}`
      // req.open('PATCH', requestUrl, true);
      // req.setRequestHeader('Content-type', 'application/json');
      // let json = JSON.stringify({ data });
      // req.send(json);
      // req.onload = () => {
      //   let data = JSON.parse(req.responseText)
      //   if (req.readyState == 4 && req.status == "201") {
      //     alert(data.message)
      //   } else {
      //     alert(data.message)
      //   }
      // }


    }


    function buttonRejectHandle(toolid) {
      const fid = userDetails.id;

      let data = {
        'toolid': toolid,
        'myId': fid,
      }

      let req = new XMLHttpRequest();
      let requestUrl = `${'http://localhost:5000/api/tools/reject'}`
      req.open('POST', requestUrl, true);
      req.setRequestHeader('Content-type', 'application/json');
      let json = JSON.stringify({ data });
      req.send(json);
      req.onload = () => {
        let data = JSON.parse(req.responseText)
        if (req.readyState == 4 && req.status == "201") {
          //alert(data.message)
          location.replace("http://localhost:5000/manage-tools.html")
        } else {
          alert(data.message)
        }
      }

    }

    function buttonAcceptHandle(toolid, quantity, noOfDays, requestid) {

      const fid = userDetails.id;

      let data = {
        'toolid': toolid,
        'quantity': quantity,
        'noOfDays': noOfDays,
        'requestid': requestid,
        'myId': fid,
      }

      console.log(data)
      let req = new XMLHttpRequest();
      let requestUrl = `${'http://localhost:5000/api/tools/accept'}`
      req.open('POST', requestUrl, true);
      req.setRequestHeader('Content-type', 'application/json');
      let json = JSON.stringify({ data });
      req.send(json);
      req.onload = () => {
        let data = JSON.parse(req.responseText)
        if (req.readyState == 4 && req.status == "201") {
          //alert(data.message)
          location.replace("http://localhost:5000/manage-tools.html")
        } else {
          alert(data.message)
        }
      }


    }
  </script>
</body>

</html>